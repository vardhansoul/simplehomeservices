<!DOCTYPE html>
<html lang="en">
<head>
    <title>Simple Home Services Booking</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        :root {
            --primary-color: #6c63ff;
            --primary-gradient: linear-gradient(135deg, #7b73ff, #6c63ff);
            --primary-hover: #5a52e0;
            --secondary-color: #00c090;
            --secondary-hover: #00a87a;
            --background-color: #f4f6f9;
            --card-background: #ffffff;
            --text-color: #1e293b;
            --text-light: #64748b;
            --border-color: #e2e8f0;
            --shadow-color: rgba(99, 102, 241, 0.1);
            --input-focus-shadow: rgba(108, 99, 255, 0.25);
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --font-family: 'Poppins', sans-serif;
            --success-color: #22c55e;
            --warning-color: #f97316;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        .main-wrapper {
            width: 100%;
            height: 100%;
            max-width: 1200px;
            margin: auto;
            display: flex;
            flex-direction: column;
        }
        .container {
            background: var(--card-background);
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        #loginContainer {
            padding: 40px;
            text-align: center;
            max-width: 500px;
        }
        .login-illustration {
            width: 100%;
            max-width: 250px;
            margin-bottom: 25px;
        }
        #loginContainer h1 { color: var(--primary-color); margin-bottom: 10px; }
        #loginContainer p { color: var(--text-light); margin-bottom: 25px; max-width: 400px; margin-left: auto; margin-right: auto; }
        #app-content { display: none; flex-direction: column; height: 100%; width: 100%; }
        #app-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            flex-shrink: 0;
        }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); }
        .user-name { font-weight: 600; font-size: 1rem; }
        .user-email { font-size: 0.8rem; color: var(--text-light); }
        #userMenuContainer { display: none; position: relative; }
        .user-menu-trigger { background: none; border: none; padding: 0; cursor: pointer; border-radius: 50%; }
        .user-menu-trigger .user-avatar { transition: box-shadow 0.2s ease; }
        .user-menu-trigger:hover .user-avatar { box-shadow: 0 0 0 4px var(--input-focus-shadow); }
        .user-menu-popup {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            width: 280px;
            background: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            padding: 15px;
            z-index: 1100;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .user-menu-popup.show { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .user-info-popup { display: flex; align-items: center; gap: 12px; }
        .user-info-popup .user-avatar { flex-shrink: 0; }
        .user-details-popup { overflow: hidden; }
        .user-details-popup .user-name, .user-details-popup .user-email { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .popup-divider { border: none; border-top: 1px solid var(--border-color); margin: 12px 0; }
        .btn-logout-popup {
            width: 100%;
            background: var(--background-color);
            color: var(--danger-color);
            font-weight: 600;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            transition: all 0.2s ease;
        }
        .btn-logout-popup:hover { background: var(--danger-color); color: white; border-color: var(--danger-color); }
        .btn {
            padding: 10px 16px; border: none; border-radius: 12px; font-size: 14px;
            font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background: var(--primary-gradient); color: #fff; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary-color); color: #fff; }
        .btn-secondary:hover:not(:disabled) { background-color: var(--secondary-hover); }
        .btn-google { background-color: var(--card-background); color: var(--text-color); border: 1px solid var(--border-color); font-weight: 500; padding: 12px 24px; font-size: 16px; }
        .btn-google i { color: #EA4335; font-size: 20px; }
        .btn-google:hover { background-color: #f8f9fa; border-color: #d8dde2; }
        .tab-content-wrapper { flex-grow: 1; background: var(--card-background); padding: 25px; border-radius: 0 0 20px 20px; overflow-y: auto; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        form { display: flex; flex-direction: column; gap: 12px; }
        .form-group { display: flex; flex-direction: column; position: relative; }
        label { font-weight: 500; margin-bottom: 4px; color: var(--text-color); font-size: 0.9rem; }
        input, select, textarea, .form-button { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 12px; font-family: inherit; font-size: 1rem; color: var(--text-color); background-color: var(--background-color); transition: all 0.3s ease; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 4px var(--input-focus-shadow); outline: none; background-color: var(--card-background); }
        .form-button { text-align: left; cursor: pointer; background-color: var(--card-background); display: flex; justify-content: space-between; align-items: center; }
        .form-button:hover { border-color: var(--primary-color); }
        .form-button-text { color: var(--text-light); }
        .form-button-text.selected { color: var(--text-color); font-weight: 500; }
        .form-row { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 768px) { .form-row { grid-template-columns: 1fr 1fr; } }
        .error-message { color: var(--danger-color); font-size: 0.8rem; margin-top: 4px; display: none; animation: fadeIn 0.3s; }
        input.invalid, select.invalid, .form-button.invalid { border-color: var(--danger-color) !important; }
        .input-with-icon { position: relative; }
        .input-with-icon .input-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            pointer-events: none;
        }
        input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0; cursor: pointer; }
        #mapid { height: 250px; width: 100%; margin-top: 10px; border-radius: 16px; box-shadow: 0 4px 15px var(--shadow-color); border: 1px solid var(--border-color); z-index: 1; }
        .address-details { margin-top: 8px; padding: 10px; border-radius: 12px; background: #f8f9fa; border: 1px solid var(--border-color); }
        .pincode-loader {
            display: none; width: 20px; height: 20px;
            border: 3px solid var(--border-color); border-top-color: var(--primary-color);
            border-radius: 50%; animation: spin 1s linear infinite;
            position: absolute; right: 15px; top: 38px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .booking-item {
            background: #fff; border: 1px solid var(--border-color); border-left: 5px solid var(--primary-color);
            border-radius: 16px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); transition: all 0.3s ease;
        }
        .booking-item:hover { transform: translateY(-4px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .booking-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .booking-services { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); max-width: 80%; }
        .sync-status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: white; }
        .sync-synced { background-color: var(--success-color); }
        .sync-pending { background-color: var(--warning-color); }
        .booking-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9rem; }
        .booking-detail { display: flex; align-items: center; gap: 8px; color: var(--text-light); }
        .booking-detail i { color: var(--primary-color); width: 16px; text-align: center; }
        .booking-detail strong { color: var(--text-color); }
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(30, 41, 59, 0.6); backdrop-filter: blur(5px);
            justify-content: center; align-items: center; padding: 15px;
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-content {
            background-color: var(--card-background); padding: 25px; border-radius: 20px; width: 100%;
            max-width: 800px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); position: relative;
            max-height: 90vh; overflow-y: auto; animation: slideIn 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { color: var(--primary-color); font-weight: 700; font-size: 1.5rem; }
        .close-btn { font-size: 2rem; font-weight: 300; color: var(--text-light); cursor: pointer; transition: color 0.2s, transform 0.2s; }
        .close-btn:hover { color: var(--text-color); transform: rotate(90deg); }
        .services-category { margin-bottom: 20px; }
        .services-category h4 { font-size: 1.1rem; color: var(--primary-color); margin-bottom: 10px; border-bottom: 2px solid var(--border-color); padding-bottom: 5px; }
        .services-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; }
        .service-item { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; border: 2px solid var(--border-color); border-radius: 16px; background-color: var(--background-color); cursor: pointer; transition: all 0.3s ease; font-size: 0.85rem; color: var(--text-color); text-align: center; }
        .service-item:hover { background-color: #e9eef2; transform: translateY(-4px); border-color: var(--primary-hover); }
        .service-item i { font-size: 2.2em; margin-bottom: 8px; color: var(--primary-color); }
        .service-item.active { border-color: var(--primary-color); background-color: rgba(108, 99, 255, 0.1); box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.3); transform: scale(1.05); }
        .cart-panel { margin-top: 20px; padding: 15px; border: 1px dashed var(--primary-color); border-radius: 12px; background: #f8f0ff; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: white; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); animation: slideInFromTop 0.3s ease-out; }
        @keyframes slideInFromTop { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .cart-item span { font-size: 0.9rem; color: var(--text-color); }
        .remove-btn { background: var(--danger-color); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; font-size: 0.8rem; cursor: pointer; transition: transform 0.2s; }
        .remove-btn:hover { transform: scale(1.1); }
        .cart-footer { display: flex; justify-content: flex-end; margin-top: 15px; gap: 10px; }
        .cart-empty { font-size: 0.9rem; color: var(--text-light); text-align: center; padding: 10px; }
        .task-bar { display: flex; justify-content: center; gap: 8px; padding: 12px; background: var(--card-background); border-radius: 20px 20px 0 0; margin-top: 15px; flex-shrink: 0; box-shadow: 0 -4px 15px var(--shadow-color); z-index: 10; }
        .task-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 6px 10px; border-radius: 12px; background: var(--background-color); color: var(--text-light); text-decoration: none; font-weight: 500; font-size: 0.75rem; transition: all 0.3s ease; flex: 1; max-width: 130px; border: 1px solid var(--border-color); cursor: pointer; }
        .task-btn i { font-size: 1.1rem; margin-bottom: 3px; }
        .task-btn:hover { background: var(--primary-color); color: white; transform: translateY(-3px); box-shadow: 0 6px 15px rgba(108,99,255,0.2); }
        .task-btn.active { background: var(--primary-gradient); color: white; border-color: var(--primary-color); }
        .booking-success-container { text-align: center; padding: 20px; background: var(--background-color); border-radius: 12px; margin-top: 20px; border: 1px solid var(--border-color); animation: fadeIn 0.5s; }
        .booking-success-container .fa-check-circle { font-size: 3rem; color: var(--success-color); }
        .booking-success-container h3 { margin-top: 15px; color: var(--text-color); }
        .share-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div id="loginContainer" class="container">
            <img src="logo.png" alt="House Services Illustration" class="login-illustration">
            <h1>Simple Home Services</h1>
            <p>Sign in to continue your bookings</p>
            <button id="loginBtn" class="btn btn-google">
                <i class="fab fa-google"></i> Continue with Google
            </button>
        </div>

        <div id="app-content">
            <header id="app-header" class="container">
                <div style="flex-grow: 1;">
                    <h3 style="color: var(--primary-color); font-weight: 700;">Simple Home Services</h3>
                </div>
                <div id="userMenuContainer">
                    <button id="userMenuTrigger" class="user-menu-trigger">
                        <img id="userAvatarTrigger" class="user-avatar" src="" alt="User Avatar">
                    </button>
                    <div id="userMenuPopup" class="user-menu-popup">
                        <div class="user-info-popup">
                            <img id="userAvatarPopup" class="user-avatar" src="" alt="User Avatar">
                            <div class="user-details-popup">
                                <p id="userNamePopup" class="user-name"></p>
                                <p id="userEmailPopup" class="user-email"></p>
                            </div>
                        </div>
                        <hr class="popup-divider">
                        <button id="logoutBtn" class="btn-logout-popup">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </header>

            <div class="task-bar">
                <button class="task-btn active" id="newServiceBtn">
                    <i class="fas fa-plus-circle"></i>
                    <span>New Booking</span>
                </button>
                <button class="task-btn" id="previousBookingsBtn">
                    <i class="fas fa-history"></i>
                    <span>My Bookings</span>
                </button>
            </div>

            <main class="tab-content-wrapper">
                <div id="booking-panel" class="tab-panel active">
                    <form id="serviceForm" novalidate>
                         <div class="form-row">
                            <div class="form-group">
                                <label>Your Name:</label>
                                <input type="text" id="name" name="name" placeholder="e.g., John Doe" required>
                                <span class="error-message">Name is required.</span>
                            </div>
                            <div class="form-group">
                                <label>Phone Number:</label>
                                <input type="tel" id="phone" name="phone" pattern="[6-9]\d{9}" maxlength="10" placeholder="10-digit mobile number" required>
                                <span class="error-message">Please enter a valid 10-digit phone number.</span>
                            </div>
                        </div>

                         <div class="form-group">
                            <label>Selected Services:</label>
                            <div id="selectedServicesCart">
                                <div class="cart-empty">No services added yet.</div>
                            </div>
                            <button type="button" id="selectServiceBtn" class="form-button" style="margin-top: 8px;">
                                <span><i class="fas fa-plus"></i> Add or Edit Services</span>
                            </button>
                            <span class="error-message" id="services-error">Please select at least one service.</span>
                        </div>

                        <div class="form-group">
                            <label>Date & Location:</label>
                            <input type="hidden" id="date" name="date" required>
                            <input type="hidden" id="time" name="time" required>
                            <input type="hidden" id="pincode" name="pincode" required>
                            <input type="hidden" id="lat" name="lat">
                            <input type="hidden" id="lng" name="lng">
                            <input type="hidden" id="doorNo" name="doorNo">
                            <input type="hidden" id="streetName" name="streetName">
                            <input type="hidden" id="landmark" name="landmark">
                            <button type="button" id="selectDateTimeLocationBtn" class="form-button">
                                <span id="selectedDateTimeLocationText" class="form-button-text">Tap to Select Date, Time & Location</span>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                             <span class="error-message" id="location-error">Date, time, and location are required.</span>
                        </div>

                        <div class="form-group">
                            <label for="details">Service Details (Optional):</label>
                            <textarea id="details" name="details" rows="3" placeholder="e.g., The tap in the kitchen is leaking."></textarea>
                        </div>
                        <button type="submit" id="submitBtn" class="btn btn-primary" style="padding: 12px;"><i class="fas fa-check-circle"></i> Send Service Details</button>
                    </form>
                    <div id="bookingSuccessMessage" style="display: none;">
                        <div class="booking-success-container">
                            <i class="fas fa-check-circle"></i>
                            <h3>Share your details via WhatsApp or SMS to get your booking confirmed!</h3>
                            <p>Your request has been saved to your device.</p>
                            <div class="share-buttons">
                                <button id="whatsapp-btn" class="btn btn-secondary"><i class="fab fa-whatsapp"></i> Send via WhatsApp</button>
                                <button id="sms-btn" class="btn btn-secondary"><i class="fas fa-sms"></i> Send via SMS</button>
                            </div>
                             <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
                            <button id="bookAnotherBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Book Another Service</button>
                        </div>
                    </div>
                </div>
                <div id="history-panel" class="tab-panel">
                    <div id="bookingsList">
                        <p class="cart-empty">No recent bookings found.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="serviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Services</h3>
                <span class="close-btn" data-modal="serviceModal">×</span>
            </div>
            <div class="cart-panel" style="margin-top: 0; margin-bottom: 20px;">
                <label>Your Selected Services:</label>
                <div id="modalCartDisplay">
                    <div class="cart-empty">No services selected yet.</div>
                </div>
            </div>
            <div id="serviceSelectionGrid">
                </div>
            <div class="cart-footer">
                <button type="button" class="btn btn-primary" id="proceedToBookingBtn"><i class="fas fa-arrow-right"></i> Confirm Services</button>
            </div>
        </div>
    </div>

    <div id="dateTimeLocationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Date, Time & Location</h3>
                <span class="close-btn" data-modal="dateTimeLocationModal">×</span>
            </div>
            <form id="dateTimeLocationForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="modal-date">Date:</label>
                        <div class="input-with-icon">
                            <input type="date" id="modal-date" name="date" required>
                            <i class="fas fa-calendar-alt input-icon"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="modal-time">Time Slot:</label>
                        <select id="modal-time" name="time" required>
                            <option value="">-- Choose --</option>
                            <option value="Morning (9am - 12pm)">Morning (9am - 12pm)</option>
                            <option value="Afternoon (12pm - 4pm)">Afternoon (12pm - 4pm)</option>
                            <option value="Evening (4pm - 8pm)">Evening (4pm - 8pm)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="modal-pincode">Pincode:</label>
                    <input type="tel" id="modal-pincode" name="pincode" pattern="\d{6}" maxlength="6" placeholder="Enter your 6-digit pincode" required>
                    <div class="pincode-loader"></div>
                </div>
                <div class="address-details" style="display: none;">
                    <strong><i class="fas fa-map-marker-alt"></i> Location Area</strong>
                    <p>District: <span id="modal-district-text"></span>, State: <span id="modal-state-text"></span></p>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="modal-doorNo">Door / Flat No.:</label>
                        <input type="text" id="modal-doorNo" name="doorNo" placeholder="e.g., 10-2-34">
                    </div>
                    <div class="form-group">
                        <label for="modal-streetName">Street / Area Name:</label>
                        <input type="text" id="modal-streetName" name="streetName" placeholder="e.g., Main Street">
                    </div>
                </div>
                <div class="form-group">
                    <label for="modal-landmark">Landmark:</label>
                    <input type="text" id="modal-landmark" name="landmark" placeholder="e.g., Near City Hospital">
                </div>
                <p style="font-size: 0.9em; color: var(--text-light);">Drag the pin to your exact location for accurate service.</p>
                <div id="mapid"></div>
                <div class="cart-footer" style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Confirm Details</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // IMPORTANT: Replace this with your actual Firebase project configuration
           const firebaseConfig = {
                apiKey: "AIzaSyDHbUeNOD14mMtCXrc40bNoLEsXYvWd2IE",
                authDomain: "simple-home-services-oo.firebaseapp.com",
                databaseURL: "https://simple-home-services-oo-default-rtdb.firebaseio.com",
                projectId: "simple-home-services-oo",
                storageBucket: "simple-home-services-oo.appspot.com",
                messagingSenderId: "1097590449578",
                appId: "1:1097590449578:web:1f6093cad7868e358037d3"
            };

            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
            } catch (e) {
                console.error("Firebase initialization error:", e);
                alert("Could not initialize the app. Please check the console for errors.");
            }

            const auth = firebase.auth();
            const database = firebase.database();
            const provider = new firebase.auth.GoogleAuthProvider();
            const businessNumber = '+919502291519'; // Business phone number for WhatsApp/SMS
            const bookingHistoryKey = 'bookingHistory';

            const servicesData = {
                "Home Needs": [
                    { name: "Plumbing", icon: "fas fa-wrench" },
                    { name: "Water Purifier", value: "Water Purifier Service", icon: "fas fa-filter" },
                    { name: "Water Tank", value: "Water Tank Cleaning", icon: "fas fa-tint" },
                    { name: "Carpentry", icon: "fas fa-hammer" },
                    { name: "Painting", icon: "fas fa-paint-roller" }
                ],
                "Electricals": [
                    { name: "Electrical", icon: "fas fa-bolt" },
                    { name: "AC Repair", icon: "fas fa-snowflake" },
                    { name: "Chimney Repair", icon: "fas fa-smog" },
                    { name: "Fan Repair", icon: "fas fa-fan" },
                    { name: "Switch Board", value: "Switch Board Repair", icon: "fas fa-lightbulb" }
                ],
                 "Electronics": [
                    { name: "Computer Repair", value: "Computer/Laptop Repair", icon: "fas fa-laptop-code" },
                    { name: "Phone Repair", value: "Mobile Phone Repair", icon: "fas fa-mobile-alt" },
                    { name: "CCTV", value: "CCTV Installation", icon: "fas fa-video" },
                    { name: "TV Repair", icon: "fas fa-tv" },
                    { name: "Fridge Repair", value: "Refrigerator Repair", icon: "fas fa-temperature-low" },
                    { name: "DTH", value: "DTH Installation/Repair", icon: "fas fa-satellite-dish" }
                ],
                "Others": [
                     { name: "Solar", icon: "fas fa-sun" },
                     { name: "Other", value: "Other Services", icon: "fas fa-ellipsis-h" }
                ]
            };

            const dom = {
                loginContainer: document.getElementById('loginContainer'),
                appContent: document.getElementById('app-content'),
                loginBtn: document.getElementById('loginBtn'),
                logoutBtn: document.getElementById('logoutBtn'),
                userMenuContainer: document.getElementById('userMenuContainer'),
                userMenuTrigger: document.getElementById('userMenuTrigger'),
                userMenuPopup: document.getElementById('userMenuPopup'),
                userAvatarTrigger: document.getElementById('userAvatarTrigger'),
                userAvatarPopup: document.getElementById('userAvatarPopup'),
                userNamePopup: document.getElementById('userNamePopup'),
                userEmailPopup: document.getElementById('userEmailPopup'),
                serviceForm: document.getElementById('serviceForm'),
                bookingSuccessMessage: document.getElementById('bookingSuccessMessage'),
                whatsappBtn: document.getElementById('whatsapp-btn'),
                smsBtn: document.getElementById('sms-btn'),
                bookAnotherBtn: document.getElementById('bookAnotherBtn'),
                nameInput: document.getElementById('name'),
                phoneInput: document.getElementById('phone'),
                detailsInput: document.getElementById('details'),
                dateInput: document.getElementById('date'),
                timeInput: document.getElementById('time'),
                pincodeInput: document.getElementById('pincode'),
                latInput: document.getElementById('lat'),
                lngInput: document.getElementById('lng'),
                doorNoInput: document.getElementById('doorNo'),
                streetNameInput: document.getElementById('streetName'),
                landmarkInput: document.getElementById('landmark'),
                selectServiceBtn: document.getElementById('selectServiceBtn'),
                selectDateTimeLocationBtn: document.getElementById('selectDateTimeLocationBtn'),
                selectedDateTimeLocationText: document.getElementById('selectedDateTimeLocationText'),
                bookingsList: document.getElementById('bookingsList'),
                selectedServicesCart: document.getElementById('selectedServicesCart'),
                proceedToBookingBtn: document.getElementById('proceedToBookingBtn'),
                modalCartDisplay: document.getElementById('modalCartDisplay'),
                serviceSelectionGrid: document.getElementById('serviceSelectionGrid'),
                dateTimeLocationForm: document.getElementById('dateTimeLocationForm'),
                modalDateInput: document.getElementById('modal-date'),
                modalTimeSelect: document.getElementById('modal-time'),
                modalPincodeInput: document.getElementById('modal-pincode'),
                modalDoorNoInput: document.getElementById('modal-doorNo'),
                modalStreetNameInput: document.getElementById('modal-streetName'),
                modalLandmarkInput: document.getElementById('modal-landmark'),
                modalAddressDetailsDiv: document.querySelector('.address-details'),
                modalDistrictSpan: document.getElementById('modal-district-text'),
                modalStateSpan: document.getElementById('modal-state-text'),
                pincodeLoader: document.querySelector('.pincode-loader'),
                newServiceBtn: document.getElementById('newServiceBtn'),
                previousBookingsBtn: document.getElementById('previousBookingsBtn'),
                servicesError: document.getElementById('services-error'),
                locationError: document.getElementById('location-error'),
            };

            let userId = null;
            let mymap, userMarker;
            let mapInitialized = false;
            let pincodeData = { district: 'N/A', state: 'N/A' };
            let serviceCart = JSON.parse(localStorage.getItem('serviceCart')) || [];
            let bookingListener = null;

            const saveToLocalStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));
            const loadFromLocalStorage = (key) => JSON.parse(localStorage.getItem(key)) || null;

            const openModal = (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    if (modalId === 'dateTimeLocationModal') {
                        setTimeout(() => {
                            if (!mapInitialized) initMap();
                            else mymap.invalidateSize();
                        }, 10);
                    }
                }
            };

            const closeModal = (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) modal.style.display = 'none';
            };

            const handleAuthStateChange = (user) => {
                if (user) {
                    userId = user.uid;
                    dom.loginContainer.style.display = 'none';
                    dom.appContent.style.display = 'flex';
                    dom.userMenuContainer.style.display = 'block';
                    document.body.style.alignItems = 'flex-start';
                    const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}&background=6c63ff&color=fff`;
                    const displayName = user.displayName || 'User';
                    const email = user.email || '';
                    dom.userAvatarTrigger.src = photoURL;
                    dom.userAvatarPopup.src = photoURL;
                    dom.userNamePopup.textContent = displayName;
                    dom.userEmailPopup.textContent = email;
                    if (!dom.nameInput.value) dom.nameInput.value = displayName;
                    syncPendingBookings();
                    startRealTimeSync();
                } else {
                    userId = null;
                    dom.loginContainer.style.display = 'block';
                    dom.appContent.style.display = 'none';
                    dom.userMenuContainer.style.display = 'none';
                    document.body.style.alignItems = 'center';
                    stopRealTimeSync();
                }
                renderBookingHistory();
            };

            const renderServiceGrid = () => {
                dom.serviceSelectionGrid.innerHTML = '';
                for (const category in servicesData) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'services-category';
                    let categoryHTML = `<h4>${category}</h4><div class="services-grid">`;
                    servicesData[category].forEach(service => {
                        const serviceValue = service.value || service.name;
                        categoryHTML += `<button type="button" class="service-item" data-value="${serviceValue}">
                            <i class="${service.icon}"></i>
                            <span>${service.name}</span>
                        </button>`;
                    });
                    categoryHTML += `</div>`;
                    categoryDiv.innerHTML = categoryHTML;
                    dom.serviceSelectionGrid.appendChild(categoryDiv);
                }
                document.querySelectorAll('.service-item').forEach(item => item.addEventListener('click', handleServiceSelection));
            };

            const updateCartDisplay = (cartContainer = dom.selectedServicesCart) => {
                if (serviceCart.length === 0) {
                    cartContainer.innerHTML = '<div class="cart-empty">No services added yet.</div>';
                    if (cartContainer === dom.selectedServicesCart) {
                        dom.selectServiceBtn.querySelector('span').innerHTML = '<i class="fas fa-plus"></i> Add or Edit Services';
                    }
                } else {
                    cartContainer.innerHTML = '';
                    serviceCart.forEach(service => {
                        const item = document.createElement('div');
                        item.className = 'cart-item';
                        item.innerHTML = `<span>${service}</span>`;
                        if (cartContainer === dom.selectedServicesCart) {
                            item.innerHTML += `<button type="button" class="remove-btn" data-service="${service}">×</button>`;
                        }
                        cartContainer.appendChild(item);
                    });
                    if (cartContainer === dom.selectedServicesCart) {
                        dom.selectServiceBtn.querySelector('span').textContent = 'Edit Services';
                        document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', handleRemoveService));
                    }
                }
            };

            const updateModalCartDisplay = () => {
                updateCartDisplay(dom.modalCartDisplay);
                document.querySelectorAll('.service-item').forEach(item => {
                    item.classList.toggle('active', serviceCart.includes(item.dataset.value));
                });
            };

            const handleServiceSelection = (e) => {
                const service = e.currentTarget.dataset.value;
                const index = serviceCart.indexOf(service);
                if (index > -1) serviceCart.splice(index, 1);
                else serviceCart.push(service);
                saveToLocalStorage('serviceCart', serviceCart);
                updateModalCartDisplay();
            };

            const handleRemoveService = (e) => {
                serviceCart = serviceCart.filter(s => s !== e.target.dataset.service);
                saveToLocalStorage('serviceCart', serviceCart);
                updateCartDisplay();
            };

            const initMap = () => {
                if(mapInitialized) return;
                mymap = L.map('mapid').setView([14.4673, 78.8242], 13); // Default to Kadapa
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(mymap);
                mapInitialized = true;
                const initialLatLng = L.latLng(parseFloat(dom.latInput.value) || 14.4673, parseFloat(dom.lngInput.value) || 78.8242);
                userMarker = L.marker(initialLatLng, { draggable: true }).addTo(mymap);
                userMarker.on('dragend', () => {
                    const latLng = userMarker.getLatLng();
                    dom.latInput.value = latLng.lat;
                    dom.lngInput.value = latLng.lng;
                });
                mymap.setView(initialLatLng, dom.latInput.value ? 17 : 13);
            };

            const handlePincodeLookup = async (pincode) => {
                dom.modalAddressDetailsDiv.style.display = 'none';
                if (pincode.length !== 6) return;
                dom.pincodeLoader.style.display = 'block';
                try {
                    const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
                    const data = await response.json();
                    if (data && data[0]?.Status === 'Success') {
                        const po = data[0].PostOffice[0];
                        pincodeData = { district: po.District, state: po.State };
                        dom.modalDistrictSpan.textContent = po.District;
                        dom.modalStateSpan.textContent = po.State;
                        dom.modalAddressDetailsDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Pincode lookup failed:", error);
                } finally {
                    dom.pincodeLoader.style.display = 'none';
                }
            };

            const handleDateTimeLocationFormSubmit = (e) => {
                e.preventDefault();
                dom.dateInput.value = dom.modalDateInput.value;
                dom.timeInput.value = dom.modalTimeSelect.value;
                dom.pincodeInput.value = dom.modalPincodeInput.value;
                dom.doorNoInput.value = dom.modalDoorNoInput.value;
                dom.streetNameInput.value = dom.modalStreetNameInput.value;
                dom.landmarkInput.value = dom.modalLandmarkInput.value;
                if (userMarker) {
                    const latLng = userMarker.getLatLng();
                    dom.latInput.value = latLng.lat;
                    dom.lngInput.value = latLng.lng;
                }
                const formattedDate = new Date(dom.dateInput.value).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
                dom.selectedDateTimeLocationText.textContent = `${formattedDate}, ${dom.timeInput.value} | Pincode: ${dom.pincodeInput.value}`;
                dom.selectedDateTimeLocationText.classList.add('selected');
                clearError(dom.selectDateTimeLocationBtn);
                dom.locationError.style.display = 'none';
                closeModal('dateTimeLocationModal');
            };

            const showError = (input, message) => {
                input.classList.add('invalid');
                const errorSpan = input.parentElement.querySelector('.error-message');
                if (errorSpan) {
                    errorSpan.textContent = message;
                    errorSpan.style.display = 'block';
                }
            };

            const clearError = (input) => {
                input.classList.remove('invalid');
                const errorSpan = input.parentElement.querySelector('.error-message');
                if (errorSpan) {
                    errorSpan.style.display = 'none';
                }
            };

            const validateForm = () => {
                let isValid = true;
                document.querySelectorAll('.error-message').forEach(e => e.style.display = 'none');
                document.querySelectorAll('.invalid').forEach(e => e.classList.remove('invalid'));
                if (!dom.nameInput.value.trim()) { showError(dom.nameInput, 'Name is required.'); isValid = false; }
                if (!dom.phoneInput.value.match(/^[6-9]\d{9}$/)) { showError(dom.phoneInput, 'Please enter a valid 10-digit phone number.'); isValid = false; }
                if (serviceCart.length === 0) { dom.selectServiceBtn.classList.add('invalid'); dom.servicesError.style.display = 'block'; isValid = false; }
                if (!dom.dateInput.value || !dom.timeInput.value || !dom.pincodeInput.value) { dom.selectDateTimeLocationBtn.classList.add('invalid'); dom.locationError.style.display = 'block'; isValid = false; }
                return isValid;
            };

            const handleServiceFormSubmit = (e) => {
                e.preventDefault();
                if (!validateForm()) return;
                const bookingId = `booking_${new Date().getTime()}`;
                const formData = {
                    id: bookingId,
                    services: serviceCart.join(', '),
                    name: dom.nameInput.value,
                    phone: dom.phoneInput.value,
                    details: dom.detailsInput.value || 'N/A',
                    date: dom.dateInput.value,
                    time: dom.timeInput.value,
                    pincode: dom.pincodeInput.value,
                    address: [dom.doorNoInput.value, dom.streetNameInput.value, dom.landmarkInput.value].filter(Boolean).join(', '),
                    lat: dom.latInput.value,
                    lng: dom.lngInput.value,
                    district: pincodeData.district,
                    state: pincodeData.state,
                    timestamp: new Date().toISOString(),
                    synced: !!(userId && navigator.onLine),
                    userId: userId,
                };
                saveBooking(formData);
                showSuccessMessage(formData);
            };

            const showSuccessMessage = (formData) => {
                dom.serviceForm.style.display = 'none';
                dom.bookingSuccessMessage.style.display = 'block';
                const locationLink = (formData.lat && formData.lng) ? `https://maps.google.com/?q=${formData.lat},${formData.lng}` : 'Location not specified.';
                const message = `*New Service Request*\n\n*Services*: ${formData.services}\n*Name*: ${formData.name}\n*Phone*: ${formData.phone}\n*Date*: ${new Date(formData.date).toLocaleDateString('en-IN')}\n*Time*: ${formData.time}\n*Address*: ${formData.address}, ${formData.pincode}\n*Location*: ${locationLink}\n*Details*: ${formData.details}`;
                const encoded = encodeURIComponent(message.trim());
                dom.whatsappBtn.onclick = () => window.open(`https://wa.me/${businessNumber}?text=${encoded}`, '_blank');
                dom.smsBtn.onclick = () => window.open(`sms:${businessNumber}?body=${encoded}`, '_blank');
            };

            const resetBookingFlow = () => {
                 dom.serviceForm.reset();
                 dom.bookingSuccessMessage.style.display = 'none';
                 dom.serviceForm.style.display = 'flex';
                 dom.selectedDateTimeLocationText.textContent = 'Tap to Select Date, Time & Location';
                 dom.selectedDateTimeLocationText.classList.remove('selected');
                 serviceCart = [];
                 saveToLocalStorage('serviceCart', []);
                 updateCartDisplay();
                 document.querySelectorAll('.error-message, .invalid').forEach(el => {
                    el.style.display = 'none';
                    el.classList.remove('invalid');
                 });
            };

            const saveBooking = (booking) => {
                let history = loadFromLocalStorage(bookingHistoryKey) || [];
                history.unshift(booking);
                saveToLocalStorage(bookingHistoryKey, history);
                if (booking.synced) {
                    database.ref(`users/${userId}/bookings/${booking.id}`).set(booking);
                }
                renderBookingHistory();
            };

            const renderBookingHistory = () => {
                const history = loadFromLocalStorage(bookingHistoryKey) || [];
                const userHistory = userId ? history.filter(b => b.userId === userId || !b.userId) : history.filter(b => !b.userId); // Show non-user specific bookings if not logged in
                if(userHistory.length === 0) {
                     dom.bookingsList.innerHTML = '<p class="cart-empty">No bookings found. Create one from the "New Booking" tab!</p>';
                     return;
                }
                dom.bookingsList.innerHTML = userHistory.map(b => {
                    const locLink = (b.lat && b.lng) ? `<a href="https://maps.google.com/?q=${b.lat},${b.lng}" target="_blank" style="text-decoration: none; color: inherit;"><strong>View on Map</strong></a>` : '<strong>N/A</strong>';
                    const syncClass = b.synced ? 'sync-synced' : 'sync-pending';
                    const syncText = b.synced ? 'Synced' : 'Pending';
                    return `<div class="booking-item">
                        <div class="booking-header">
                           <span class="booking-services">${b.services}</span>
                           <span class="sync-status-badge ${syncClass}">${syncText}</span>
                        </div>
                        <div class="booking-details-grid">
                            <div class="booking-detail"><i class="fas fa-user"></i> <strong>${b.name}</strong></div>
                            <div class="booking-detail"><i class="fas fa-phone"></i> <strong>${b.phone}</strong></div>
                            <div class="booking-detail"><i class="fas fa-calendar-alt"></i> <strong>${new Date(b.date).toLocaleDateString('en-IN', {day: 'numeric', month: 'long', year: 'numeric'})}</strong></div>
                            <div class="booking-detail"><i class="fas fa-clock"></i> <strong>${b.time}</strong></div>
                            <div class="booking-detail"><i class="fas fa-map-marker-alt"></i> ${locLink}</div>
                        </div>
                    </div>`;
                }).join('');
            };

            const syncPendingBookings = async () => {
                if (!userId || !navigator.onLine) return;
                let history = loadFromLocalStorage(bookingHistoryKey) || [];
                let hasChanges = false;
                const syncPromises = history.map(booking => {
                    if (!booking.synced) {
                        booking.synced = true;
                        booking.userId = userId;
                        hasChanges = true;
                        return database.ref(`users/${userId}/bookings/${booking.id}`).set(booking);
                    }
                    return Promise.resolve();
                });
                await Promise.all(syncPromises);
                if (hasChanges) {
                    saveToLocalStorage(bookingHistoryKey, history);
                    renderBookingHistory();
                }
            };

            const startRealTimeSync = () => {
                if (userId && !bookingListener) {
                    const userBookingsRef = database.ref(`users/${userId}/bookings`);
                    bookingListener = userBookingsRef.on('value', (snapshot) => {
                        const firebaseBookings = snapshot.val();
                        if (firebaseBookings) {
                            let localHistory = loadFromLocalStorage(bookingHistoryKey) || [];
                            // Merge Firebase data with local data, Firebase is the source of truth
                            const firebaseBookingsMap = new Map(Object.entries(firebaseBookings));
                            localHistory = localHistory.map(localBooking =>
                                firebaseBookingsMap.has(localBooking.id) ? firebaseBookingsMap.get(localBooking.id) : localBooking
                            );
                            firebaseBookingsMap.forEach((fbBooking, id) => {
                                if (!localHistory.some(b => b.id === id)) {
                                    localHistory.push(fbBooking);
                                }
                            });

                            localHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                            saveToLocalStorage(bookingHistoryKey, localHistory);
                            renderBookingHistory();
                        }
                    });
                }
            };

            const stopRealTimeSync = () => {
                if (bookingListener && userId) {
                    database.ref(`users/${userId}/bookings`).off('value', bookingListener);
                    bookingListener = null;
                }
            };

            const setupNavigation = () => {
                const taskBtns = [dom.newServiceBtn, dom.previousBookingsBtn];
                const panels = { newServiceBtn: 'booking-panel', previousBookingsBtn: 'history-panel' };
                taskBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        taskBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                        document.getElementById(panels[btn.id]).classList.add('active');
                    });
                });
            };

            // --- INITIALIZATION ---
            auth.onAuthStateChanged(handleAuthStateChange);
            renderServiceGrid();
            updateCartDisplay();
            setupNavigation();
            dom.modalDateInput.setAttribute('min', new Date().toISOString().split('T')[0]);

            // Event Listeners
            dom.loginBtn.addEventListener('click', () => auth.signInWithRedirect(provider));
            dom.logoutBtn.addEventListener('click', () => auth.signOut());

            dom.userMenuTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                dom.userMenuPopup.classList.toggle('show');
            });
            window.addEventListener('click', () => {
                if (dom.userMenuPopup.classList.contains('show')) {
                    dom.userMenuPopup.classList.remove('show');
                }
            });

            dom.selectServiceBtn.addEventListener('click', () => {
                updateModalCartDisplay();
                openModal('serviceModal');
            });
            dom.proceedToBookingBtn.addEventListener('click', () => {
                updateCartDisplay();
                clearError(dom.selectServiceBtn);
                dom.servicesError.style.display = 'none';
                closeModal('serviceModal');
            });
            dom.selectDateTimeLocationBtn.addEventListener('click', () => openModal('dateTimeLocationModal'));

            document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.dataset.modal)));
            window.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) closeModal(e.target.id); });

            dom.dateTimeLocationForm.addEventListener('submit', handleDateTimeLocationFormSubmit);
            dom.serviceForm.addEventListener('submit', handleServiceFormSubmit);
            dom.bookAnotherBtn.addEventListener('click', resetBookingFlow);
            dom.modalPincodeInput.addEventListener('input', e => handlePincodeLookup(e.target.value));
        });
    </script>
</body>
</html>
